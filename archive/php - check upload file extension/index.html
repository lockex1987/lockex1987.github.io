<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta content="text/html; charset=UTF-8" http-equiv="content-type">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Laravel">
    <title>Kiểm tra định dạng file upload</title>
    <link rel="icon" href="../../images/favicon.png">
    <link rel="stylesheet" href="../../css/style.css">
  </head>
  <body>
    <article>
      <h2>Kiểm tra định dạng file upload</h2>
      <p>Phải luôn kiểm tra định dạng file upload. Đặc biệt với các dự án PHP
        (Laravel), bởi vì định dạng <code>.php</code> là một định dạng có thể
        thực thi được.</p>
      <p>Tạo một project Laravel để demo:</p>
      <pre>composer create-project --prefer-dist laravel/laravel test-upload-extension</pre>
      <p>Chạy project:</p>
      <pre>php artisan serve</pre>
      <p>Kiểm tra project đã chạy bình thường:</p>
      <p><a target="_blank" href="http://localhost:8000/">http://localhost:8000/</a></p>
      <p>Giả sử bạn có một ứng dụng mà cho phép người dùng upload ảnh đại diện.</p>
      <p>Bạn có thể thêm thuộc tính sau vào thẻ <code>&lt;input type="file"
          /&gt;</code>, nhưng đó chỉ là validate ở frontend, hoàn toàn có thể bị
        disable dễ dàng.</p>
      <pre>accept="image/*,.png,.jpeg,.jpg,.gif;capture=camera"</pre>
      <p>Code phần frontend (<code>resources/views/welcome.blade.php</code>):</p>
      <pre>&lt;!doctype html&gt;
&lt;html&gt;
    &lt;head&gt;
        &lt;meta charset="utf-8"&gt;
        &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;

        &lt;!-- CSRF Token --&gt;
        &lt;meta name="csrf-token" content="{{ csrf_token() }}"&gt;

        &lt;title&gt;Laravel&lt;/title&gt;

        &lt;link rel="stylesheet" href="/css/app.css"&gt;
    &lt;/head&gt;

    &lt;body&gt;
        &lt;div class="container mt-5"&gt;
            &lt;input type="file"
                    id="avatar"
                    onchange="updateAvatar()"&gt;
        &lt;/div&gt;

        &lt;script src="/js/app.js"&gt;&lt;/script&gt;
        &lt;script&gt;
            /**
             * Các request AJAX thêm CRSF token để phòng chống lỗi CSRF.
             */
            function _setupCsrfAjax() {
                $.ajaxSetup({
                    headers: {
                        'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                    }
                });
            }

            /**
             * Đổi ảnh avatar.
             */
            function updateAvatar() {
                var fileData = $('#avatar').prop('files')[0];   
                var params = new FormData();
                params.append('avatar', fileData);
                $.ajax({
                    url: '/update-avatar',
                    dataType: 'json',
                    cache: false,
                    contentType: false,
                    processData: false,
                    data: params,
                    type: 'POST',
                    success: function (resp) {
                        alert('Đổi ảnh đại diện thành công');
                    }
                });
            }

            $(document).ready(function () {
                _setupCsrfAjax();
            });
        &lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;</pre>
      <p>Code phần backend (<code>routes/web.php</code>):</p>
      <pre>&lt;?php

use Illuminate\Http\Request;

Route::get('/', function () {
    return view('welcome');
});

Route::post('/update-avatar', function (Request $request) {
    /*
    $request-&gt;validate([
        'avatar' =&gt; 'required|image|mimes:jpeg,png,jpg,gif,svg|max:2048'
    ]);
    */

    $avatarName = 'avatar.' . $request-&gt;avatar-&gt;getClientOriginalExtension();
    $request-&gt;avatar-&gt;storeAs('public/avatars', $avatarName);

    return [
        'code' =&gt; 0,
        'avatarName' =&gt; $avatarName
    ];
});
</pre>
      <p>Tạo shortcut đến thư mục storage.</p>
      <pre>php artisan storage:link</pre>
      <p>Chạy lại, thử upload file <a target="_blank" href="image.jpg">image.jpg</a>.</p>
      <p>Kiểm tra ảnh đã upload thành công:</p>
      <p><a target="_blank" href="http://localhost:8000/storage/avatars/avatar.jpg">http://localhost:8000/storage/avatars/avatar.jpg</a></p>
      <p>Hãy thử upload file <a href="test.php">test.php</a>.</p>
      <p>Sau đó truy cập đường dẫn:</p>
      <p><a target="_blank" href="http://localhost:8000/storage/avatars/avatar.php">http://localhost:8000/storage/avatars/avatar.php</a></p>
      <p>Bạn sẽ thấy code PHP được thực thi.</p>
	  <p><img src="phpinfo.png"/></p>
    </article>
    <script src="../../js/docs.js"></script>
  </body>
</html>
